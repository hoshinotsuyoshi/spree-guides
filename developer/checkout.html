<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="lt-ie9"> <![endif]-->
<!--[if IE 9]>    <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!--> <html lang="en" > <!--<![endif]-->
<head>
  <title>The Checkout Flow API - Developer Guide | Spree Commerce</title>

  <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="section" content="customization" />

<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />

<!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link href="/shared/css/icons.css" media="screen" rel="stylesheet" type="text/css">
<link href="/shared/css/icons-codes.css" media="screen" rel="stylesheet" type="text/css">

<!--[if IE 7]>
  <link href="/shared/css/icons-ie7.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/shared/css/icons-ie7-codes.css" media="screen" rel="stylesheet" type="text/css">
<![endif]-->

<link href="/shared/css/skeleton.css" media="screen" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
<link href="/shared/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/assets/stylesheets/guides.css" media="screen" />

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-migrate/1.1.1/jquery-migrate.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
<script src="/assets/javascripts/css_browser_selector_dev.js" type="text/javascript"></script>
<script src="/assets/javascripts/jquery.toc.js" type="text/javascript"></script>
<!-- <script src="/assets/javascripts/waypoints.js" type="text/javascript"></script>
<script src="/assets/javascripts/waypoints-sticky.js" type="text/javascript"></script> -->
<script src="/assets/javascripts/documentation.js" type="text/javascript"></script>

<script type="text/javascript">
$(function(){
  $.ajax({
    url: document.location.protocol + '//munchkin.marketo.net/munchkin.js',
    dataType: 'script',
    cache: true,
    success: function() { Munchkin.init('893-PDJ-826'); }
  });
});
</script>
<script type="text/javascript" src="//use.typekit.net/tcx0cap.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    

</head>
<body class="developer">
  
  <header id="header">
    <div id="top-header">
      <div class="container">

        <div class="row">

          <div class="five columns">
            <a class="logo" href="http://spreecommerce.com"><img src='/images/logo.png' /></a>
          </div>

          <nav id="main-menu" class="eleven columns">
  <ul class="inline">
    <li><a href="../">Home</a></li>
    <li><a href="../user/">User</a></li>
    <li><a href="../developer/">Developer</a></li>
    <li><a href="http://spreecommerce.com/docs/hub/" target="_blank">Hub</a></li>
    <li><a href="../api/">API</a></li>
    <li><a href="../release_notes/">Release Notes</a></li>
  </ul>
</nav>


        </div>

      </div>
    </div>

    <div id="subheader">
      <div class="container">
        <div class="twelve columns">
          <h1 class="page-title">The Checkout Flow API - Developer Guide | Spree Commerce</h1>
        </div>
      </div>
    </div>

  </header>

  <div class="container" id="main">
    <section id="main-content">

      <div class="twelve columns">
        <div id="content">
          <h2 id="overview">Overview</h2>

<p>The Spree checkout process has been designed for maximum flexibility. It’s been redesigned several times now, each iteration has benefited from the feedback of real world deployment experience. It is relatively simple to customize the checkout process to suit your needs. Secure transmission of customer information is possible via SSL and credit card information is never stored in the database.</p>

<p>The customization of the flow of the checkout can be done by using Spree’s <code>checkout_flow</code> DSL, described in the <a href="#the-checkout-flow-dsl">Checkout Flow DSL</a> section below.</p>

<h2 id="default-checkout-steps">Default Checkout Steps</h2>

<p>The Spree checkout process consists of the following steps. With the exception of the Registration step, each of these steps corresponds to a state of the <code>Spree::Order</code> object):</p>

<ul>
  <li>Registration (Optional - only if using spree_auth_devise extension, can be toggled through the <code>Spree::Auth::Config[:registration_step]</code> configuration setting)</li>
  <li>Address Information</li>
  <li>Delivery Options (Shipping Method)</li>
  <li>Payment</li>
  <li>Confirmation</li>
</ul>

<p>The following sections will provide a walk-though of a checkout from a user’s perspective, and offer some information on how to configure the default behavior of the various steps.</p>

<h3 id="registration">Registration</h3>

<p>Prior to beginning the checkout process, the customer will be prompted to create a new account or to login to their existing account. By default, there is also a “guest checkout” option which allows users to specify only their email address if they do not wish to create an account.</p>

<p>Technically, the registration step is not an actual state in the <code>Spree::Order</code> state machine. The <code>spree_auth_devise</code> gem (an extension that comes with Spree by default) adds the <code>check_registration</code> before filter to the all actions of <code>Spree::CheckoutController</code> (except for obvious reasons the <code>registration</code> and <code>update_registration</code> actions), which redirects to a registration page unless one of the following is true:</p>

<ul>
  <li><code>Spree::Auth::Config[:registration_step]</code> preference is not <code>true</code></li>
  <li>user is already logged in</li>
  <li>the current order has an email address associated with it</li>
</ul>

<p>The method is defined like this:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="keyword">def</span> <span class="function">check_registration</span>
  <span class="keyword">return</span> <span class="keyword">unless</span> <span class="constant">Spree</span>::<span class="constant">Auth</span>::<span class="constant">Config</span>[<span class="symbol">:registration_step</span>]
  <span class="keyword">return</span> <span class="keyword">if</span> spree_current_user <span class="keyword">or</span> current_order.email
  store_location
  redirect_to spree.checkout_registration_path
<span class="keyword">end</span>

</pre></div>
</div>
</div>

<p>The configuration of the guest checkout option is done via <a href="preferences.html">Preferences</a>. Spree will allow guest checkout by default. Use the <code>allow_guest_checkout</code> preference to change the default setting.</p>

<h3 id="address-information">Address Information</h3>

<p>This step allows the customer to add both their billing and shipping information. Customers can click the “use billing address” option to use the same address for both. Selecting this option will have the effect of hiding the shipping address fields using JavaScript. If users have disabled JavaScript, the section will not disappear but it will copy over the address information once submitted. If you would like to automatically copy the address information via JavaScript on the client side, that is an exercise left to the developer. We have found the server side approach to be simpler and easier to maintain.</p>

<p>The address fields include a select box for choosing state/province. The list of states will be populated via JavaScript and will contain all of the states listed in the database for the currently selected country. If there are no states configured for a particular country, or if the user has JavaScript disabled, the select box will be replaced by a text field instead.</p>

<div class="note"><p>The default “seed” data for Spree only includes the U.S. states. It’s easy enough to add states or provinces for other countries but beyond the scope of the Spree project to maintain such a list.</p>
</div>

<div class="note"><p>The state field can be disabled entirely by using the <code>Spree::Config[:address_requires_state]</code> preference. You can also allow for an “alternate phone” field by using the <code>Spree::Config[:alternative_billing_phone]</code> and <code>Spree::Config[:alternative_shipping]</code> fields.</p>
</div>

<p>The list of countries that appear in the country select box can also be configured. Spree will list all countries by default, but you can configure exactly which countries you would like to appear. The list can be limited to a specific set of countries by configuring the <code>Spree::Config[:checkout_zone]</code> preference and setting its value to the name of a <a href="addresses.html#zones">Zone</a> containing the countries you wish to use. Spree assumes that the list of billing and shipping countries will be the same. You can always change this logic via an extension if this does not suit your needs.</p>

<h3 id="delivery-options">Delivery Options</h3>

<p>**************** TODO ****************</p>
<p>Better shipment documentation here after split_shipments merge.</p>
<p>**************************************</p>

<p>During this step, the user may choose a delivery method. Spree assumes the list of shipping methods to be dependent on the shipping address. This is one of the reasons why it is difficult to support single page checkout for customers who have disabled JavaScript.</p>

<h3 id="payment">Payment</h3>

<p>This step is where the customer provides payment information. This step is intentionally placed last in order to minimize security issues with credit card information. Credit card information is never stored in the database so it would be impossible to have a subsequent step and still be able to submit the information to the payment gateway. Spree submits the information to the gateway before saving the model so that the sensitive information can be discarded before saving the checkout information.</p>

<p>Spree stores only the last four digits of the credit card number along with the expiration information. The full credit card number and verification code are never stored in the Spree database.</p>

<p>Several gateways such as ActiveMerchant and Beanstream provide a secure method for storing a “payment profile” in your database. This approach typically involves the use of a “token” which can be used for subsequent purchases but only with your merchant account. If you are using a secure payment profile it would then be possible to show a final “confirmation” step after payment information is entered.</p>

<p>If you do not want to use a gateway with payment profiles then you will need to customize the checkout process so that your final step submits the credit card information. You can then perform an authorization before the order is saved. This is perfectly secure because the credit card information is not ever saved. It’s transmitted to the gateway and then discarded like normal.</p>

<div class="warning"><p>Spree discards the credit card number after this step is processed. If
you do not have a gateway with payment profiles enabled then your card
information will be lost before it’s time to authorize the card.</p>
</div>

<p>For more information about payments, please see the <a href="payments.html">Payments guide</a>.</p>

<h3 id="confirmation">Confirmation</h3>

<p>This is the final opportunity for the customer to review their order before
submitting it to be processed. Users have the opportunity to return to any step
in the process using either the back button or by clicking on the appropriate
step in the “progress breadcrumb.”</p>

<p>This step is disabled by default (except for payment methods that support
payment profiles), but can be enabled by overriding the <code>confirmation_required?</code>
method in <code>Spree::Order</code>.</p>

<h2 id="checkout-architecture">Checkout Architecture</h2>

<p>The following is a detailed summary of the checkout architecture. A complete
understanding of this architecture will allow you to be able to customize the
checkout process to handle just about any scenario you can think of. Feel free
to skip this section and come back to it later if you require a deeper
understanding of the design in order to customize your checkout.</p>

<h3 id="checkout-routes">Checkout Routes</h3>

<p>Three custom routes in spree_core handle all of the routing for a checkout:</p>

<div><div class="CodeRay">
  <div class="code"><pre>put <span class="string"><span class="delimiter">'</span><span class="content">/checkout/update/:state</span><span class="delimiter">'</span></span>, <span class="symbol">:to</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">checkout#update</span><span class="delimiter">'</span></span>, <span class="symbol">:as</span> =&gt; <span class="symbol">:update_checkout</span>
get <span class="string"><span class="delimiter">'</span><span class="content">/checkout/:state</span><span class="delimiter">'</span></span>, <span class="symbol">:to</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">checkout#edit</span><span class="delimiter">'</span></span>, <span class="symbol">:as</span> =&gt; <span class="symbol">:checkout_state</span>
get <span class="string"><span class="delimiter">'</span><span class="content">/checkout</span><span class="delimiter">'</span></span>, <span class="symbol">:to</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">checkout#edit</span><span class="delimiter">'</span></span>, <span class="symbol">:as</span> =&gt; <span class="symbol">:checkout</span>

</pre></div>
</div>
</div>

<p>The ‘/checkout’ route maps to the <code>edit</code> action of the
<code>Spree::CheckoutController</code>. A request to this route will redirect to the
current state of the current order. If the current order was in the “address”
state, then a request to ‘/checkout’ would redirect to ‘/checkout/address’.</p>

<p>The ‘/checkout/:state’ route is used for the previously mentioned route, and
also maps to the <code>edit</code> action of <code>Spree::CheckoutController</code>.</p>

<p>The ‘/checkout/update/:state’ route maps to the
<code>Spree::CheckoutController#update</code> action and is used in the checkout form to
update order data during the checkout process.</p>

<h3 id="spreecheckoutcontroller">Spree::CheckoutController</h3>

<p>The <code>Spree::CheckoutController</code> drives the state of an order during checkout.
Since there is no “checkout” model, the <code>Spree::CheckoutController</code> is not a
typical RESTful controller. The spree_core and spree_auth_devise gems expose a
few different actions for the <code>Spree::CheckoutController</code>.</p>

<p>The <code>edit</code> action renders the checkout/edit.html.erb template, which then
renders a partial with the current state, such as
<code>app/views/spree/checkout/address.html.erb</code>. This partial shows state-specific
fields for the user to fill in. If you choose to customize the checkout flow to
add a new state, you will need to create a new partial for this state.</p>

<p>The <code>update</code> action performs the following:</p>

<ul>
  <li>Updates the <code>current_order</code> with the paramaters passed in from the current
step.</li>
  <li>Transitions the order state machine using the <code>next</code> event after successfully
updating the order.</li>
  <li>Executes callbacks based on the new state after successfully transitioning.</li>
  <li>Redirects to the next checkout step if the <code>current_order.state</code> is anything
other than <code>complete</code>, else redirect to the <code>order_path</code> for <code>current_order</code></li>
</ul>

<div class="note"><p>For security reasons, the <code>Spree::CheckoutController</code> will not update the
order once the checkout process is complete. It is therefore impossible for an
order to be tampered with (ex. changing the quantity) after checkout.</p>
</div>

<h3 id="filters">Filters</h3>

<p>The <code>spree_core</code> and the default authentication gem (<code>spree_auth_devise</code>) gems
define several <code>before_filters</code> for the <code>Spree::CheckoutController</code>:</p>

<ul>
  <li><code>load_order</code>: Assigns the <code>@order</code> instance variable and sets the <code>@order.state</code> to the <code>params[:state]</code> value. This filter also runs the “before” callbacks for the current state.</li>
  <li><code>check_authorization</code>: Verifies that the <code>current_user</code> has access to <code>current_order</code>.</li>
  <li><code>check_registration</code>: Checks the registration status of <code>current_user</code> and redirects to the registration step if necessary.</li>
</ul>

<h3 id="the-order-model-and-state-machine">The Order Model and State Machine</h3>

<p>The <code>Spree::Order</code> state machine is the foundation of the checkout process. Spree makes use of the <a href="https://github.com/pluginaweek/state_machine">state_machine</a> gem in the <code>Spree::Order</code> model as well as in several other places (such as <code>Spree::Shipment</code> and <code>Spree::InventoryUnit</code>.)</p>

<p>The default checkout flow for the <code>Spree::Order</code> model is defined in
<code>app/models/spree/order/checkout.rb</code> of spree_core.</p>

<p>An <code>Spree::Order</code> object has an initial state of ‘cart’. From there any number
of events transition the <code>Spree::Order</code> to different states. Spree does not
have a separate model or database table for the shopping cart. What the user
considers a “shopping cart” is actually an in-progress <code>Spree::Order</code>. An order
is considered in-progress, or incomplete when its <code>completed_at</code> attribute is
<code>nil</code>. Incomplete orders can be easily filtered during reporting and it’s also
simple enough to write a quick script to periodically purge incomplete orders
from the system. The end result is a simplified data model along with the
ability for store owners to search and report on incomplete/abandoned orders.</p>

<div class="note"><p>For more information on the state machine gem please see the <a href="https://github.com/pluginaweek/state_machine">README</a></p>
</div>

<h2 id="checkout-customization">Checkout Customization</h2>

<p>It is possible to override the default checkout workflow to meet your store’s needs.</p>

<h3 id="customizing-an-existing-step">Customizing an Existing Step</h3>

<p>Spree allows you to customize the individual steps of the checkout process.
There are a few distinct scenarios that we’ll cover here.</p>

<ul>
  <li>Adding logic either before or after a particular step.</li>
  <li>Customizing the view for a particular step.</li>
</ul>

<h3 id="adding-logic-before-or-after-a-particular-step">Adding Logic Before or After a Particular Step</h3>

<p>The state_machine gem allows you to implement callbacks before or after
transitioning to a particular step. These callbacks work similarly to <a href="http://guides.rubyonrails.org/active_record_callbacks.html">Active Record Callbacks</a>
in that you can specify a method or block of code to be executed prior to or
after a transition. If the method executed in a before_transition returns false,
then the transition will not execute.</p>

<p>So, for example, if you wanted to verify that the user provides a valid zip code
before transitioning to the delivery step, you would first implement a
<code>valid_zip_code?</code> method, and then tell the state machine to run this method
before that transition, placing this code in a file called
<code>app/models/spree/order_decorator.rb</code>:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="constant">Spree</span>::<span class="constant">Order</span>.state_machine.before_transition <span class="symbol">:to</span> =&gt; <span class="symbol">:delivery</span>, <span class="symbol">:do</span> =&gt; <span class="symbol">:valid_zip_code?</span>

</pre></div>
</div>
</div>

<p>This callback would prevent transitioning to the <code>delivery</code> step if
<code>valid_zip_code?</code> returns false.</p>

<h3 id="customizing-the-view-for-a-particular-step">Customizing the View for a Particular Step</h3>

<p>Each of the default checkout steps has its own partial defined in the
spree frontend <code>app/views/spree/checkout</code> directory. Changing the view for an
existing step is as simple as overriding the relevant partial in your site
extension. It’s also possible the default partial in question defines a usable
theme hook, in which case you could add your functionality by using
<a href="https://github.com/spree/deface">Deface</a></p>

<h2 id="the-checkout-flow-dsl">The Checkout Flow DSL</h2>

<p>Since Spree 1.2, Spree comes with a new checkout DSL that allows you succinctly define the
different steps of your checkout. This new DSL allows you to customize <em>just</em>
the checkout flow, while maintaining the unrelated admin states, such as
“canceled” and “resumed”, that an order can transition to. Ultimately, it
provides a shorter syntax compared with overriding the entire state machine for
the <code>Spree::Order</code> class.</p>

<p>The default checkout flow for Spree is defined like this, adequately
demonstrating the abilities of this new system:</p>

<div><div class="CodeRay">
  <div class="code"><pre>checkout_flow <span class="keyword">do</span>
  go_to_state <span class="symbol">:address</span>
  go_to_state <span class="symbol">:delivery</span>
  go_to_state <span class="symbol">:payment</span>, <span class="keyword">if</span>: -&gt;(order) {
    order.update_totals
    order.payment_required?
  }
  go_to_state <span class="symbol">:confirm</span>, <span class="keyword">if</span>: -&gt;(order) { order.confirmation_required? }
  go_to_state <span class="symbol">:complete</span>
  remove_transition <span class="symbol">:from</span> =&gt; <span class="symbol">:delivery</span>, <span class="symbol">:to</span> =&gt; <span class="symbol">:confirm</span>

</pre></div>
</div>
</div>

<p>we can pass a block on each checkout step definition and work some logic to
figure if the step is required dynamically. e.g. the confirm step might only
be necessary for payment gateways that support payment profiles.</p>

<p>These conditional states present a situation where an order could transition
from delivery to one of payment, confirm or complete. In the default checkout,
we never want to transition from delivery to confirm, and therefore have removed
it using the <code>remove_transition</code> method of the Checkout DSL. The resulting
transitions between states look like the image below:</p>

<p>**************** TODO ****************</p>
<p>State diagram</p>
<p>**************************************</p>

<p>These two helper methods are provided on <code>Spree::Order</code> instances for your
convenience:</p>

<ul>
  <li><code>checkout_steps</code>: returns a list of all the potential states of the checkout.</li>
  <li><code>has_step?</code>: Used to check if the current order fulfills the requirements for a specific state.</li>
</ul>

<p>If you want a list of all the currently available states for the checkout, use
the <code>checkout_steps</code> method, which will return the steps in an array.</p>

<h3 id="modifying-the-checkout-flow">Modifying the checkout flow</h3>

<p>To add or remove steps to the checkout flow, you can use the <code>insert_checkout_step</code>
and <code>remove_checkout_step</code> helpers respectively.</p>

<p>The <code>insert_checkout_step</code> takes a <code>before</code> or <code>after</code> option to determine where to
insert the step:</p>

<div><div class="CodeRay">
  <div class="code"><pre>insert_checkout_step <span class="symbol">:new_step</span>, <span class="symbol">:before</span> =&gt; <span class="symbol">:address</span>
<span class="comment"># or</span>
insert_checkout_step <span class="symbol">:new_step</span>, <span class="symbol">:after</span> =&gt; <span class="symbol">:address</span>

</pre></div>
</div>
</div>

<p>The <code>remove_checkout_step</code> will remove just one checkout step at a time:</p>

<div><div class="CodeRay">
  <div class="code"><pre>remove_checkout_step <span class="symbol">:address</span>
remove_checkout_step <span class="symbol">:delivery</span>

</pre></div>
</div>
</div>

<p>What will happen here is that when a user goes to checkout, they will be asked
to (potentially) fill in their payment details and then (potentially) confirm
the order. This is the default behavior of the payment and the confirm steps
within the checkout. If they are not required to provide payment or confirmation
for this order then checking out this order will result in its immediate completion.</p>

<p>To completely re-define the flow of the checkout, use the <code>checkout_flow</code> helper:</p>

<div><div class="CodeRay">
  <div class="code"><pre>checkout_flow <span class="keyword">do</span>
  go_to_state <span class="symbol">:payment</span>
  go_to_state <span class="symbol">:complete</span>
<span class="keyword">end</span>

</pre></div>
</div>
</div>

<h3 id="the-checkout-view">The Checkout View</h3>
<p>After creating a checkout step, you’ll need to create a partial for the checkout
controller to load for your custom step. If your additonal checkout step is
<code>new_step</code> you’ll need to a <code>spree/checkout/_new_step.html.erb</code> partial.</p>

<h3 id="the-checkout-breadcrumb">The Checkout “Breadcrumb”</h3>

<p>The Spree code automatically creates a progress “breadcrumb” based on the
available checkout states. The states listed in the breadcrumb come from the
<code>Spree::Order#checkout_steps</code> method. If you add a new state you’ll want to add
a translation for that state in the relevant translation file located in the
<code>config/locales</code> directory of your extension or application:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="key">en</span>:
  <span class="key">order_state</span>:
    <span class="key">new_step</span>: <span class="constant">New</span> <span class="constant">Step</span>

</pre></div>
</div>
</div>

<div class="note"><p>The default use of the breadcrumb is entirely optional.  It does not need
to correspond to checkout states, nor does every state need to be represented.
Feel free to customize this behavior to meet your exact requirements.</p>
</div>

<h2 id="payment-profiles">Payment Profiles</h2>

<p>The default checkout process in Spree assumes a gateway that allows for some
form of third party support for payment profiles.  An example of such a service
would be <a href="http://www.authorize.net/solutions/merchantsolutions/merchantservices/cim/">Authorize.net CIM</a>
Such a service allows for a secure and PCI compliant means of storing the users
credit card information.  This allows merchants to issue refunds to the credit
card or to make changes to an existing order without having to leave Spree and
use the gateway provider’s website.  More importantly, it allows us to have a
final “confirmation” step before the order is processed since the number is
stored securely on the payment step and can still be used to perform the
standard authorization/capture via the secure token provided by the gateway.</p>

<p>Spree provides a wrapper around the standard active merchant API in order to
provide a common abstraction for dealing with payment profiles.  All <code>Gateway</code>
classes now have a <code>payment_profiles_supported?</code> method which indicates whether
or not payment profiles are supported.  If you are adding Spree support to a
<code>Gateway</code> you should also implement the <code>create_profile</code> method.  The following
is an example of the implementation of <code>create_profile</code> used in the
<code>AuthorizeNetCim</code> class:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="comment"># Create a new CIM customer profile ready to accept a payment</span>
<span class="keyword">def</span> <span class="function">create_profile</span>(payment)
  <span class="keyword">if</span> payment.source.gateway_customer_profile_id.nil?
    profile_hash = create_customer_profile(payment)
    payment.source.update_attributes({
      <span class="symbol">:gateway_customer_profile_id</span> =&gt; profile_hash[<span class="symbol">:customer_profile_id</span>],
      <span class="symbol">:gateway_payment_profile_id</span> =&gt; profile_hash[<span class="symbol">:customer_payment_profile_id</span>])
    })
  <span class="keyword">end</span>
<span class="keyword">end</span>

</pre></div>
</div>
</div>

<div class="warning"><p>Most gateways do not yet support payment profiles but the default
checkout process of Spree assumes that you have selected a gateway that supports
this feature.  This allows users to enter credit card information during the
checkout without having to store it in the database.  Spree has never stored
credit card information in the database but prior to the use of profiles, the
only safe way to handle this was to post the credit card information in the
final step.  It should be possible to customize the checkout so that the credit
card information is entered on the final step and then you can authorize the
card before Spree automatically discards the sensitive data before saving.</p>
</div>

        </div>
      </div>

    </section>

    <aside id="sidebar" class="four columns">
  <nav id="sidebar-menu">
    <ul>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-tutorial-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/getting_started_tutorial.html'>Tutorials</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/getting_started_tutorial.html'>Getting Started</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/extensions_tutorial.html'>Extensions</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/deface_overrides_tutorial.html'>Deface Overrides</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-source-code-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/about.html'>Source Code</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/about.html'>About</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/navigating.html'>Navigating</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/getting_help.html'>Getting Help</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/contributing.html'>Contributing</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-core-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/addresses.html'>The Core</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/addresses.html'>Addresses</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/adjustments.html'>Adjustments</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/calculators.html'>Calculators</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/inventory.html'>Inventory</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/payments.html'>Payments</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/preferences.html'>Preferences</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/products.html'>Products</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/promotions.html'>Promotions</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/orders.html'>Orders</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/shipments.html'>Shipments</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/taxation.html'>Taxation</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-customization-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/authentication.html'>Customization</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/authentication.html'>Authentication</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/i18n.html'>Internationalization (i18n)</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/view.html'>View</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/asset.html'>Asset</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/logic.html'>Logic</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/s3_storage.html'>Use S3</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/checkout.html'>Checkout</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-deployment-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/deployment-service.html'>Deployment</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/ninefold.html'>Ninefold</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/heroku.html'>Heroku</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/ansible-ubuntu.html'>Ansible Ubuntu Deployment</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/manual-ubuntu.html'>Manual Ubuntu Deployment</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/deployment_options.html'>Deployment Options</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/deployment-service.html'>Deployment Service</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/deployment_tips.html'>Deployment Tips</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/requesting_and_configuring_ssl.html'>Requesting/Configuring SSL</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-advanced-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/seo.html'>Advanced Topics</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/seo.html'>Search Engine Optimization</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/developer_tips.html'>Developer Tips</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/migration.html'>Migrating to Spree</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/security.html'>Security</a> <div class="toc"></div> </li>
          <li><i class="icon-dot"></i><a href='/developer/testing.html'>Testing Spree Applications</a> <div class="toc"></div> </li>
        </ul>
      </li>
      <li class='js-topic'>
        <h3>
          <a href="#" class="js-expand-btn collapsed toggle-advanced-menu"><i class="icon-right-open"></i></a>
          <a href='/developer/upgrades/index.html'>Upgrade Guides</a>
        </h3>
        <ul class="js-guides">
          <li><i class="icon-dot"></i><a href='/developer/upgrades/point-sixty-to-point-seventy.html'>0.60.x to 0.70.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/point-seventy-to-one-dot-oh.html'>0.70.x to 1.0.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/one-dot-oh-to-one-dot-one.html'>1.0.x to 1.1.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/one-dot-one-to-one-dot-two.html'>1.1.x to 1.2.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/one-dot-two-to-one-dot-three.html'>1.2.x to 1.3.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/one-dot-three-to-two-dot-oh.html'>1.3.x to 2.0.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/two-dot-oh-to-two-dot-one.html'>2.0.x to 2.1.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/two-dot-one-to-two-dot-two.html'>2.1.x to 2.2.x</a> <div
          class="toc"></div></li>
          <li><i class="icon-dot"></i><a href='/developer/upgrades/two-dot-two-to-two-dot-three.html'>2.2.x to 2.3.x</a> <div 
          class="toc"></div></li>
        </ul>
      </li>
    </ul>
  </nav>
</aside>

  </div>

  <footer id="main-footer">

  <div class="footer-top">
    <div class="container">
      <div id="link-blocks" class="row">

        <div class="link-block three columns">
          <h3 class="block-title">Product</h3>
          <ul>
            <li><a href='http://spreecommerce.com/storefront'>Platform</a></li>
            <li><a href='http://spreecommerce.com/hub/'>Hub</a></li>
            <li><a href='http://spreecommerce.com/training_and_support'>Support</a></li>
            <li><a href='http://spreecommerce.com/privacy_policy'>Privacy Policy</a></li>
            <li><a href='http://spreecommerce.com/terms_of_service'>Terms of Service</a></li>
          </ul>
        </div>

        <div class="link-block three columns">
          <h3 class="block-title">Developers</h3>
          <ul>
            <li><a href="http://spreecommerce.com/storefront">Overview</a></li>
            <li><a href="http://guides.spreecommerce.com/developer">Documenation</a></li>
            <li><a href="http://spreecommerce.com/storefront">Community</a></li>
            <li><a href="http://spreecommerce.com/license">License</a></li>
          </ul>
        </div>
        <div class="link-block three columns">
          <h3 class="block-title">Partners</h3>
          <ul>
            <li><a href="http://spreecommerce.com/solution_partners">Pro Services</a></li>
            <li><a href="http://spreecommerce.com/training_and_support">Training</a></li>
            <li><a href="http://spreecommerce.com/become_a_partner">Partnership Program</a></li>
            <li><a href="http://spreecommerce.com/partners/payments">Payments</a></li>
          </ul>
        </div>

        <div class="link-block four columns">
          <h3 class="block-title">About Spree Commerce</h3>
          <p>
            Spree Commerce is an automated enterprise solution built specifically for ecommerce. We effectively manage your operations so you can focus on serving your customers and growing your business.
          </p>
        </div>

        <div class="link-block three columns">
          <h3 class="block-title">Take it for a test drive</h3>
          <p>
            You can even create your own personal store.
          </p>
          <a href="http://spreecommerce.com/demo" target="_blank" class="button"><i class="icon-right"></i> Try The Demo</a>
        </div>

      </div>
    </div>
  </div>


  <div class="footer-bottom">
    <div class="container">
      <div class="row">

        <div class="copyright ten columns">
          <p>
            Spree, Spree Commerce and “Behind the Best Storefronts” are all trademarks of Spree Commerce Inc.
          </p>
        </div>

        <div class="social-icons six columns">
          <ul class="inline">
            <li><a href="https://github.com/spree/spree" target="_blank"><i class="icon-github-circled"></i></a></li>
            <li><a href="https://twitter.com/spreecommerce" target="_blank"><i class="icon-twitter-circled"></i></a></li>
            <li><a href="https://www.facebook.com/spreecommerce" target="_blank"><i class="icon-facebook-circled"></i></a></li>
            <li><a href="https://plus.google.com/110792218022940311363" target="_blank"><i class="icon-gplus-circled"></i></a></li>
          </ul>
        </div>

      </div>
    </div>
  </div>
</footer>
<!-- google analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3914566-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>
